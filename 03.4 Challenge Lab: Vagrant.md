## Vagrant with VirtualBox, UTM, and KVM


**Prerequisites Installation**

**On Both Systems:**
1. **Install VirtualBox** (if not already installed)
   - Download from: https://www.virtualbox.org/wiki/Downloads
   - Choose the version for your OS (macOS/Windows)

2. **Install Vagrant**
   - Download from: https://www.vagrantup.com/downloads
   - Choose the appropriate installer for your OS
   - Or Install through CLI
     - Macbook
       ```
       brew tap hashicorp/tap
       brew install hashicorp/tap/hashicorp-vagrant
       ```
     - Linux
       - Ubuntu/Debian
       ```
       wget -O - https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
       echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(grep -oP '(?<=UBUNTU_CODENAME=).*' /etc/os-release || lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
       sudo apt update && sudo apt install vagrant
       ```
       - CentOS/RedHat
       ```
       sudo yum install -y yum-utils
       sudo yum-config-manager --add-repo https://rpm.releases.hashicorp.com/RHEL/hashicorp.repo
       sudo yum -y install vagrant
       ```


3. **Verify Installation**
   ```bash
   # Open Terminal (macOS) or Command Prompt/PowerShell (Windows)
   vagrant --version
   vboxmanage --version
   ```

---
**Part 1: Vagrant with VirtualBox (Windows)**
>VirtualBox DOES NOT support ARM on Mac for Vagrant.

**Step 1: Initialize a Vagrant Project**
```bash
mkdir my-vagrant-project
cd my-vagrant-project

vagrant init                             # Initializes a brand new Vagrantfile in the current directory

# Example: Initialize with Ubuntu 20.04 (focal64) base box
vagrant init ubuntu/focal64                    # Initialize with a base box (Ubuntu example)

# Example: Initialize with CentOS 7 base box
vagrant init  centos/stream9                      # Initialize with a base box (centos/stream9 example)

# Example: Initialize with Fedora's latest base box
vagrant init fedora/39-cloud-base           # Initialize with a base box (Fedora 39 example)

```
> You can find more official box names at https://app.vagrantup.com/boxes/search

**Step 2: Customize the Vagrantfile**

`sudo vim Vagrantfile` remove all the existing contents inside `Vagrantfile` and add:
```ruby
# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  # Base box: change below as needed, e.g., "centos/7" or "fedora/39-cloud-base"
  config.vm.box = "ubuntu/focal64"   # e.g. "centos/7" for CentOS 7

  # Provider-specific settings
  config.vm.provider "virtualbox" do |vb|
    vb.memory = "2048"
    vb.cpus = 2
    vb.name = "my-ubuntu-vm"
  end

  # Network configuration
  config.vm.network "private_network", ip: "192.168.33.10"

  # Shared folders
  config.vm.synced_folder "./data", "/vagrant_data"

  # Provisioning (optional, adjust for CentOS/Fedora)
  config.vm.provision "shell", inline: <<-SHELL
    apt-get update
    apt-get install -y nginx
  SHELL
end
```

**Step 3: Start the Virtual Machine**
```bash
# Start the VM
vagrant up

# If you have multiple providers, specify VirtualBox
vagrant up --provider=virtualbox
```
>Default Username and Password are:
>username-vagrant
>Password-vagrant

**- Example 1:**

   <img width="1917" height="830" alt="Capture" src="https://github.com/user-attachments/assets/f895c896-d722-4cd0-a33b-c91c62252d38" />


   <img width="1917" height="1027" alt="Capture1" src="https://github.com/user-attachments/assets/7320bd16-9064-4351-b970-53a56a7ab7fb" />


**Step 4: Connect to the VM**
```bash
# SSH into the VM
vagrant ssh

# Check status
vagrant status

# Suspend the VM
vagrant suspend

# Halt (shutdown) the VM
vagrant halt

# Destroy (remove) the VM
vagrant destroy
```

**Common Vagrant Commands**
```bash
# List installed boxes
vagrant box list

# Add a new box
vagrant box add ubuntu/focal64

# Reload VM after Vagrantfile changes
vagrant reload

# Reload with provisioning
vagrant reload --provision

# Export VM to OVA format
vagrant package --output myvm.ova
```

**- Example 2**
```
# -*- mode: ruby -*-
# vi: set ft=ruby :

# Multi-VM Vagrantfile example with custom per-VM user password provisioners
# NOTE: If running on ARM Mac, you must use ARM64 boxes and a supported provider such as Parallels or VMware Fusion instead of VirtualBox.

Vagrant.configure("2") do |config|
  # Hostmanager plugin settings (maps IP/hostname in /etc/hosts)
  config.hostmanager.enabled = true
  config.hostmanager.manage_host = true

  # ----- Database VM -----
  config.vm.define "db01" do |db01|
    db01.vm.box = "eurolinux-vagrant/centos-stream-9"
    db01.vm.box_version = "9.0.48"
    db01.vm.hostname = "database01"
    db01.vm.network "private_network", ip: "192.168.56.90"
    db01.vm.provider "virtualbox" do |vb|
      vb.memory = "2048"
    end
    # Set password for default user 'vagrant'
    db01.vm.provision "shell", inline: <<-SHELL
      echo "vagrant:dbpass123" | chpasswd
    SHELL
  end

  # ----- Memcache VM -----
  config.vm.define "mc01" do |mc01|
    mc01.vm.box = "eurolinux-vagrant/centos-stream-9"
    mc01.vm.box_version = "9.0.43"
    mc01.vm.hostname = "mc01"
    mc01.vm.network "private_network", ip: "192.168.56.91"
    mc01.vm.provider "virtualbox" do |vb|
      vb.memory = "2048"
    end
    mc01.vm.provision "shell", inline: <<-SHELL
      echo "vagrant:mcpass123" | chpasswd
    SHELL
  end

  # ----- RabbitMQ VM -----
  config.vm.define "rmq01" do |rmq01|
    rmq01.vm.box = "eurolinux-vagrant/centos-stream-9"
    rmq01.vm.box_version = "9.0.43"
    rmq01.vm.hostname = "rmq01"
    rmq01.vm.network "private_network", ip: "192.168.56.92"
    rmq01.vm.provider "virtualbox" do |vb|
      vb.memory = "2048"
    end
    rmq01.vm.provision "shell", inline: <<-SHELL
      echo "vagrant:rmqpass123" | chpasswd
    SHELL
  end

  # ----- Tomcat VM -----
  config.vm.define "app01" do |app01|
    app01.vm.box = "eurolinux-vagrant/centos-stream-9"
    app01.vm.box_version = "9.0.43"
    app01.vm.hostname = "app01"
    app01.vm.network "private_network", ip: "192.168.56.93"
    app01.vm.provider "virtualbox" do |vb|
      vb.memory = "4096"
    end
    app01.vm.provision "shell", inline: <<-SHELL
      echo "vagrant:apppass123" | chpasswd
    SHELL
  end

  # ----- Nginx VM -----
  config.vm.define "web01" do |web01|
    web01.vm.box = "ubuntu/jammy64"
    web01.vm.hostname = "web01"
    web01.vm.network "private_network", ip: "192.168.56.94"
    web01.vm.provider "virtualbox" do |vb|
      vb.gui = true
      vb.memory = "4096"
    end
    web01.vm.provision "shell", inline: <<-SHELL
      echo "vagrant:webpass123" | chpasswd
    SHELL
  end
end
```

---

**Part 2: Vagrant with UTM on macOS**

**Can Vagrant work with UTM?**
  - Yes, but with limitations, Vagrant doesn't have native UTM support, but you can use UTM as a provider via:
    - QEMU provider (since UTM uses QEMU backend)
    - Custom provider plugin (community developed)

**Option 1: Using Vagrant's QEMU Provider**

**Step 1: Install Required Software**
```bash
# Install QEMU
brew install qemu

# Install Vagrant QEMU plugin
vagrant plugin install vagrant-qemu
```

**Step 2: Configure Vagrantfile for QEMU**

```
mkdir vagrantQEMU
cd vagrantQEMU 
vagrant init
```
`vim Vagrantfile`
```ruby
Vagrant.configure("2") do |config|
  config.vm.box = "generic/ubuntu2204"

  config.vm.provider :qemu do |qemu|
    qemu.memory = 2048
    qemu.cpus = 2
    qemu.arch = "x86_64"
    qemu.machine = "q35"
    qemu.accelerator = "hvf" # macOS Hypervisor Framework
    qemu.cpu = "qemu64" 
  end
end
```

**Step 3: Start the VM**
```bash
vagrant up --provider=qemu
```

**Option 2: Using UTM Directly (Manual Approach)**

Since there's no official UTM provider, you can:

**Step 1: Create UTM VM Manually**
1. Create VM in UTM GUI
2. Export as `.utm` package

**Step 2: Use Vagrant for Provisioning Only**
```ruby
# Vagrantfile for provisioning an existing UTM VM
Vagrant.configure("2") do |config|
  config.vm.define "utm-vm" do |node|
    # Disable default Vagrant provider
    node.vm.provider :virtualbox do |vb|
      vb.functional = false
    end
    
    # Custom provisioning for your UTM VM
    node.vm.provision "shell",
      inline: "echo 'This would provision your UTM VM'"
  end
end
```

**Option 3: Community UTM Plugin (Experimental)**

```bash
# Install community plugin (if available)
vagrant plugin install vagrant-utm

# Configure Vagrantfile
Vagrant.configure("2") do |config|
  config.vm.provider :utm do |utm|
    utm.utm_path = "/path/to/utm.app"
    utm.memory = 2048
    utm.cpus = 2
  end
end
```

---

**Part 3: KVM Setup on Linux**

**Step 1: Install KVM and Dependencies**

**Ubuntu/Debian:**
```bash
# Install KVM and virtualization packages
sudo apt update
sudo apt install -y qemu-kvm libvirt-daemon-system libvirt-clients \
    bridge-utils virtinst virt-manager

# Install build tools for vagrant-libvirt
sudo apt install -y build-essential libxslt-dev libxml2-dev \
    libvirt-dev zlib1g-dev ruby-dev

# Add user to libvirt group
sudo usermod -a -G libvirt,kvm $(whoami)
newgrp libvirt
```

**Fedora/RHEL/CentOS:**
```bash
# Install KVM
sudo dnf install -y qemu-kvm libvirt virt-install virt-viewer virt-manager
sudo dnf install -y libxslt-devel libxml2-devel libvirt-devel \
    libguestfs-tools-c ruby-devel

# Start and enable services
sudo systemctl start libvirtd
sudo systemctl enable libvirtd

# Add user to groups
sudo usermod -a -G libvirt $(whoami)
```

**Step 2: Install Vagrant Libvirt Plugin**
```bash
# Install the plugin
vagrant plugin install vagrant-libvirt

# If you encounter issues, try with dependencies:
sudo apt install -y pkg-config  # Ubuntu/Debian
# OR
sudo dnf install -y pkgconfig   # Fedora/RHEL

# If still having issues, install from specific branch:
vagrant plugin install vagrant-libvirt --plugin-version 0.7.0
```

**Step 3: Find KVM-Compatible Boxes**
```bash
# Search for libvirt boxes
vagrant box search ubuntu --provider libvirt

# Browse available boxes at:
# https://app.vagrantup.com/boxes/search?provider=libvirt

# Popular KVM boxes:
# - generic/ubuntu2204
# - centos/stream8
# - debian/bullseye64
```

**Step 4: Create Vagrantfile for KVM**
```ruby
Vagrant.configure("2") do |config|
  config.vm.box = "generic/ubuntu2204"
  
  # KVM/libvirt provider configuration
  config.vm.provider :libvirt do |libvirt|
    # VM Resources
    libvirt.memory = 2048
    libvirt.cpus = 2
    
    # Disk configuration
    libvirt.disk_bus = 'virtio'
    libvirt.storage_pool_name = 'default'
    libvirt.volume_cache = 'none'
    
    # Network configuration
    libvirt.management_network_name = 'vagrant-libvirt'
    libvirt.management_network_address = '192.168.121.0/24'
    
    # Graphics (optional)
    libvirt.graphics_type = 'spice'
    libvirt.video_type = 'qxl'
    
    # For better performance
    libvirt.nested = true
    libvirt.cpu_mode = 'host-passthrough'
  end
  
  # Shared folders (use 9p for better performance)
  config.vm.synced_folder ".", "/vagrant", type: "9p",
    accessmode: "passthrough", mount: true
  
  # Network configuration
  config.vm.network "private_network", 
    ip: "192.168.50.10",
    libvirt__network_name: "vagrant-network"
  
  # Bridged network (optional)
  # config.vm.network "public_network",
  #   dev: "br0",
  #   mode: "bridge",
  #   type: "bridge"
  
  # Provisioning
  config.vm.provision "shell", inline: <<-SHELL
    apt-get update
    apt-get install -y curl git build-essential
  SHELL
end
```

**Step 5: Initialize and Start KVM VM**
```bash
# Initialize with a libvirt box
vagrant init generic/ubuntu2204

# Start the VM with KVM provider
vagrant up --provider=libvirt

# Check status
vagrant status

# SSH into the VM
vagrant ssh

# List libvirt VMs
sudo virsh list --all
```

**Step 6: Advanced KVM Configuration Examples**

**Example 1: Multiple VMs with Private Network**
```ruby
Vagrant.configure("2") do |config|
  config.vm.define "web" do |web|
    web.vm.box = "generic/ubuntu2204"
    web.vm.hostname = "web-server"
    web.vm.provider :libvirt do |libvirt|
      libvirt.memory = 1024
      libvirt.cpus = 1
    end
    web.vm.network "private_network", ip: "192.168.50.10"
  end
  
  config.vm.define "db" do |db|
    db.vm.box = "generic/ubuntu2204"
    db.vm.hostname = "db-server"
    db.vm.provider :libvirt do |libvirt|
      libvirt.memory = 2048
      libvirt.cpus = 2
    end
    db.vm.network "private_network", ip: "192.168.50.11"
  end
end
```

**Example 2: Nested Virtualization**
```ruby
config.vm.provider :libvirt do |libvirt|
  libvirt.memory = 4096
  libvirt.cpus = 4
  libvirt.nested = true
  libvirt.cpu_mode = 'host-passthrough'
  libvirt.cpu_features = { 'vmx' => 'require' }
end
```

**Example 3: GPU Passthrough (Advanced)**
```ruby
config.vm.provider :libvirt do |libvirt|
  libvirt.memory = 8192
  libvirt.cpus = 8
  
  # PCI device passthrough
  libvirt.hostdevs = [
    {
      :type => 'pci',
      :domain => '0',
      :bus => '6',
      :slot => '0',
      :function => '0'
    }
  ]
end
```

**Step 7: Useful KVM-Specific Commands**
```bash
# Manage libvirt networks
sudo virsh net-list --all
sudo virsh net-edit vagrant-libvirt

# Check VM XML configuration
sudo virsh dumpxml <vm-name>

# Take snapshot
sudo virsh snapshot-create-as <vm-name> snapshot1

# Clone VM
sudo virt-clone --original <original-vm> --name <new-vm> --auto-clone

# Monitor performance
sudo virt-top

# Export VM
sudo virsh dumpxml <vm-name> > vm-config.xml
```

**Step 8: Troubleshooting KVM**

**Common Issues and Solutions:**

1. **Permission Denied:**
```bash
# Check groups
groups $(whoami)

# Fix permissions
sudo chown -R $(whoami):$(whoami) ~/.vagrant.d
```

2. **Network Issues:**
```bash
# Restart libvirt networking
sudo virsh net-destroy vagrant-libvirt
sudo virsh net-start vagrant-libvirt
sudo systemctl restart libvirtd
```

3. **Plugin Installation Issues:**
```bash
# Install missing dependencies
sudo apt install -y libvirt-dev ruby-dev build-essential

# Reinstall plugin
vagrant plugin uninstall vagrant-libvirt
vagrant plugin install vagrant-libvirt
```

4. **Disk Space Issues:**
```bash
# Check storage pool
sudo virsh pool-list --all
sudo virsh vol-list default

# Resize disk
sudo qemu-img resize /var/lib/libvirt/images/<disk>.qcow2 +10G
```

**Part 4: UTM on macOS (Updated with more details)**

**Step 1: Install QEMU for UTM Backend**
```bash
# Install QEMU with Homebrew
brew install qemu

# Install Vagrant QEMU plugin
vagrant plugin install vagrant-qemu

# For Apple Silicon (M1/M2/M3):
brew install qemu
arch -arm64 brew install qemu  # If on Apple Silicon
```

**Step 2: Configure Vagrantfile for UTM/QEMU**
```ruby
Vagrant.configure("2") do |config|
  config.vm.box = "generic/ubuntu2204"
  
  config.vm.provider :qemu do |qemu|
    # Apple Silicon (ARM64)
    if RUBY_PLATFORM.include?('arm64') || RUBY_PLATFORM.include?('aarch64')
      qemu.arch = "aarch64"
      qemu.machine = "virt"
      qemu.cpu = "cortex-a72"
      qemu.box_arch = "aarch64"
    else
      # Intel Mac
      qemu.arch = "x86_64"
      qemu.machine = "q35"
    end
    
    # Common settings
    qemu.memory = 2048
    qemu.cpus = 2
    qemu.accelerator = "hvf"  # macOS Hypervisor Framework
    
    # Disk settings
    qemu.disk_bus = "virtio"
    qemu.disk_interface = "virtio"
    
    # Network
    qemu.net_device = "virtio-net"
    qemu.net_bridge = "en0"  # Your network interface
    
    # Display (optional)
    qemu.display = "none"  # Headless
    # qemu.display = "cocoa"  # GUI display
    
    # Shared folders (requires 9p support)
    qemu.shared_folders = {
      "/vagrant" => {
        :hostpath => ".",
        :protocol => "9p",
        :mount_tag => "vagrant"
      }
    }
  end
  
  # Network configuration
  config.vm.network "private_network", 
    type: "dhcp",
    qemu__use_virtio: true
  
  # Alternative: Static IP
  # config.vm.network "private_network", 
  #   ip: "192.168.50.10",
  #   qemu__netdev: "user"
  
  # Provisioning
  config.vm.provision "shell", inline: <<-SHELL
    echo "Running on UTM via QEMU"
  SHELL
end
```

**Step 3: Import QEMU VM to UTM**
After creating with Vagrant, convert to UTM:

1. **Locate the QEMU disk image:**
```bash
# Usually in:
cd ~/.vagrant.d/boxes/
# Or in your project directory under .vagrant/machines/
```

2. **Create new VM in UTM:**
   - Open UTM â†’ "Create a New Virtual Machine"
   - Choose "Virtualize"
   - Select "Other" for OS type
   - Import existing disk image
   - Configure RAM/CPU to match Vagrant settings

3. **Convert disk format (if needed):**
```bash
# Convert qcow2 to UTM format
qemu-img convert -f qcow2 -O raw input.qcow2 output.raw
```

**Part 5: Provider Specific recommendations**

**Performance Optimization:**

**KVM:**
```ruby
config.vm.provider :libvirt do |libvirt|
  libvirt.memory_backing = [
    :access_mode => "shared"
  ]
  libvirt.nic_model_type = "virtio"
  libvirt.disk_driver :cache => "none", :io => "native"
  libvirt.random :model => "random"
end
```

**VirtualBox:**
```ruby
config.vm.provider "virtualbox" do |vb|
  vb.customize [
    "modifyvm", :id,
    "--cpus", "2",
    "--memory", "2048",
    "--hwvirtex", "on",
    "--nestedpaging", "on",
    "--largepages", "on"
  ]
end
```

**Multi-Provider Vagrantfile:**
```ruby
Vagrant.configure("2") do |config|
  config.vm.box = "generic/ubuntu2204"
  
  # Provider-agnostic settings
  config.vm.synced_folder ".", "/vagrant"
  config.vm.provision "shell", path: "bootstrap.sh"
  
  # Provider-specific overrides
  config.vm.provider "virtualbox" do |vb, override|
    vb.memory = 2048
    vb.cpus = 2
    override.vm.box = "ubuntu/focal64"
  end
  
  config.vm.provider :libvirt do |libvirt, override|
    libvirt.memory = 4096
    libvirt.cpus = 4
    override.vm.synced_folder ".", "/vagrant", type: "9p"
  end
  
  config.vm.provider :qemu do |qemu, override|
    qemu.memory = 2048
    qemu.cpus = 2
    # ARM64 box for Apple Silicon
    override.vm.box = "generic/ubuntu2204-arm64"
  end
end
```

---

**Recommendations**

1. **For consistency across MacBook and Windows:**
   - Use **VirtualBox** as your primary provider
   - It's fully supported and works identically on both platforms

2. **For macOS-only development with UTM:**
   - Consider using **Docker** with Vagrant instead
   - Or use UTM GUI directly and manage provisioning with **Ansible** or **Shell scripts**

3. **Alternative for Apple Silicon Macs:**
   ```ruby
   # Use parallels provider for better macOS integration
   vagrant plugin install vagrant-parallels
   config.vm.provider "parallels" do |prl|
     prl.memory = 2048
     prl.cpus = 2
   end
   ```


**Example**

Here's a complete example for a development environment:

```ruby
Vagrant.configure("2") do |config|
  config.vm.box = "ubuntu/focal64"
  
  config.vm.provider "virtualbox" do |vb|
    vb.memory = "4096"
    vb.cpus = 2
    vb.customize ["modifyvm", :id, "--vram", "128"]
  end
  
  config.vm.network "private_network", ip: "192.168.33.10"
  config.vm.synced_folder ".", "/vagrant", type: "virtualbox"
  
  config.vm.provision "shell", inline: <<-SHELL
    # Update system
    apt-get update
    apt-get upgrade -y
    
    # Install development tools
    apt-get install -y git curl build-essential
  SHELL
end
```

Run with:
```bash
vagrant up
vagrant ssh
```

> Note: UTM integration with Vagrant is limited. For production workflows, use VirtualBox for cross-platform compatibility, or consider using cloud providers (such as AWS or Azure) with Vagrant for more advanced scenarios.
