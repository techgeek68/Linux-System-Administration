## Vagrant with VirtualBox, UTM, and KVM

- Vagrant is an open source tool developed by HashiCorp that enables the creation and management of lightweight, reproducible, and portable development environments.
- It provides a consistent workflow for configuring and provisioning virtual machines across different platforms.

**Features**
   - Environment Consistency:
      - Solves the "works on my machine" problem
        
   - Multi Provider Support:
      - Works with VirtualBox, VMware, Hyper-V, Docker, and is extensible via plugins
        
   - Infrastructure as Code:
      - Environments defined in version controlled Vagrantfile
        
   - Automated Provisioning:
      - Supports Shell scripts, Ansible, Chef, Puppet, SaltStack
        
   - Easy Collaboration:
      - Share `Vagrantfile` with team members for identical environments

---

**Vagrant Commands**

| **Category**               | **Command**                            | **Description**                                                                 |
|----------------------------|----------------------------------------|---------------------------------------------------------------------------------|
| **Vagrant Lifecycle**      | `vagrant init`                         | Initializes a new Vagrant environment by creating a `Vagrantfile`.             |
|                            | `vagrant up`                           | Starts and provisions the Vagrant environment.                                 |
|                            | `vagrant halt`                         | Stops the running Vagrant machine (shuts it down).                             |
|                            | `vagrant reload`                       | Restarts the Vagrant machine.                                                  |
|                            | `vagrant suspend`                      | Saves the current state and pauses the machine.                                |
|                            | `vagrant resume`                       | Resumes a suspended Vagrant machine.                                           |
|                            | `vagrant destroy`                      | Stops and deletes all Vagrant machine resources.                               |
| **Box Management**         | `vagrant box add <box-name>`           | Adds a new Vagrant box (local file or from a URL).                             |
|                            | `vagrant box list`                     | Lists all installed Vagrant boxes.                                             |
|                            | `vagrant box remove <box-name>`        | Removes an existing box from the local system.                                 |
| **SSH & File Access**      | `vagrant ssh`                          | Opens an SSH session to the running Vagrant machine.                           |
|                            | `vagrant rsync`                        | Synchronizes files between the local and Vagrant machines.                     |
| **Provisioning**           | `vagrant provision`                    | Runs provisioning scripts defined in the `Vagrantfile`.                        |
| **Environment Status**     | `vagrant status`                       | Shows the current state of all Vagrant machines.                               |
|                            | `vagrant global-status`                | Lists all Vagrant environments and their statuses.                             |
| **Plugins**                | `vagrant plugin install <plugin-name>` | Installs a Vagrant plugin.                                                     |
| **Version & Help**         | `vagrant version`                      | Displays the installed Vagrant version.                                        |
|                            | `vagrant help`                         | Displays help for Vagrant commands.                                            |

---

**Use Cases**
   - Development Environments:
      - Consistent setup across the team
        
   - Testing/CI:
      - Isolated test environments
        
   - Learning/Experimentation:
      - Safe sandbox environments
        
   - Demo/Proof of Concept:
      - Quickly share working setups

**Advantages**
   - Rapid setup:
      - Minutes instead of hours
        
   - Disposable:
      - Easy to rebuild from scratch
        
   - Version controlled:
      - Environment configuration in source control
        
   - Multi provider:
      - Switch between virtualization platforms
        
   - Extensible:
      - Plugin system for customization

**Limitations**
   - Not for production:
      - Designed for development only
        
   - Performance overhead:
      - Virtualization layer impact
        
   - Learning curve:
      - Requires understanding of virtualization concepts
        
   - Resource intensive:
      - Requires adequate host system resources

---

**Alternatives**
   - Docker/Podman:
      - Container based environments
        
   - Terraform:
      - Infrastructure provisioning (more production focused)
        
   - Cloud IDE:
      - Cloud based development environments
        
   - Manual setup:
      - Traditional VM configuration
     
---

**Prerequisites Installation**

1. **Install VirtualBox** (Only if not already installed)
   - Download from: https://www.virtualbox.org/wiki/Downloads
   - Choose the version for your OS (macOS/Windows)

2. **Install Vagrant**
   - Download from: https://www.vagrantup.com/downloads
   - Choose the appropriate installer for your OS
     Or
   - Install through CLI
     
        - For MacOS
       ```
       brew tap hashicorp/tap
       brew install hashicorp/tap/hashicorp-vagrant
       ```
     >VirtualBox DOES NOT support ARM on Mac for Vagrant.
     
        - For Linux
          - Ubuntu/Debian
       ```
       wget -O - https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
       echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(grep -oP '(?<=UBUNTU_CODENAME=).*' /etc/os-release || lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
       sudo apt update && sudo apt install vagrant
       ```
       
          - For CentOS/RedHat
       ```
       sudo yum install -y yum-utils
       sudo yum-config-manager --add-repo https://rpm.releases.hashicorp.com/RHEL/hashicorp.repo
       sudo yum -y install vagrant
       ```

3. **Verify Installation**
   ```bash
   vagrant --version                                             # Open Terminal (macOS/Linux) or Command Prompt/PowerShell (Windows)
   ```

---

**Part 1: Vagrant with VirtualBox and Windows Operating System**

**- Example 1**

- Initialize:
```
vagrant init generic/fedora28 --box-version 4.3.12
```

- `sudo vim Vagrantfile`                                                 #For Linux
- `notepad Vagrantfile`                                                  #For Windows
```ruby
Vagrant.configure("2") do |config|
  config.vm.box = "generic/fedora28"
  config.vm.box_version = "4.3.12"
end
```

- Start
```
vagrant up
```

<img width="1902" height="732" alt="vagrantfedora" src="https://github.com/user-attachments/assets/c09c0fba-68b1-420d-a9d6-d808c54f1912" />


<img width="1906" height="709" alt="Vagrantfedora1" src="https://github.com/user-attachments/assets/42f92372-6442-4435-ae7d-0742a2580a74" />


<img width="1906" height="1025" alt="Vagrant2" src="https://github.com/user-attachments/assets/599a61a6-9aba-4353-9a1f-f183e00b398c" />

---

**- Example 2**

- Initialize a Vagrant Project
```bash
mkdir my-vagrant-project
```
```bash
cd my-vagrant-project
```
```bash
vagrant init                                                  # Initializes a brand new Vagrantfile in the current directory
```

Or

- Define basebox while initializing
   - Examples:
```
vagrant init ubuntu/focal64                                   # Initialize with a base box (Ubuntu example)

vagrant init  centos/stream9                                  # Initialize with a base box (centos/stream9 example)
```
   > You can find more official box names at https://portal.cloud.hashicorp.com/vagrant/discover


- Customize the Vagrantfile:
  
   - `sudo vim Vagrantfile`                                                    #For Linux
     
   - `notepad Vagrantfile`                                                     #For Windows

Remove all the existing contents inside `Vagrantfile`, and add:

```ruby
# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  config.vm.box = "ubuntu/focal64"

  # Provider-specific settings
  config.vm.provider "virtualbox" do |vb|
    vb.memory = "2048"
    vb.cpus = 2
    vb.name = "my-ubuntu-vm"
  end

  # Network configuration
  config.vm.network "private_network", ip: "192.168.33.10"

  # Shared folders
  config.vm.synced_folder "./data", "/vagrant_data"

  # Provisioning (optional)
  config.vm.provision "shell", inline: <<-SHELL
    apt-get update
    apt-get install -y nginx
  SHELL
end
```

- Start the Virtual Machine
```bash
vagrant up                                                # Start the VM

vagrant up --provider=virtualbox                          # If you have multiple providers, specify VirtualBox
```

- Result
   >Username: vagrant, Password: vagrant

   <img width="1917" height="830" alt="Capture" src="https://github.com/user-attachments/assets/f895c896-d722-4cd0-a33b-c91c62252d38" />


   <img width="1917" height="1027" alt="Capture1" src="https://github.com/user-attachments/assets/7320bd16-9064-4351-b970-53a56a7ab7fb" />


- Connect to the VM
```bash
vagrant ssh                                 # SSH into the VM

vagrant status                              # Check status

vagrant suspend                             # Suspend the VM

vagrant halt                                # Halt (shutdown) the VM

vagrant destroy                             # Destroy (remove) the VM
```

---

**- Example 3**
```
# -*- mode: ruby -*-
# vi: set ft=ruby :

# Multi-VM Vagrantfile example with custom per-VM user password provisioners
# NOTE: If running on an ARM Mac, you must use ARM64 boxes and a supported provider such as Parallels or VMware Fusion instead of VirtualBox.

Vagrant.configure("2") do |config|
  # Hostmanager plugin settings (maps IP/hostname in /etc/hosts)
  config.hostmanager.enabled = true
  config.hostmanager.manage_host = true

  # ----- Database VM -----
  config.vm.define "db01" do |db01|
    db01.vm.box = "eurolinux-vagrant/centos-stream-9"
    db01.vm.box_version = "9.0.48"
    db01.vm.hostname = "database01"
    db01.vm.network "private_network", ip: "192.168.56.90"
    db01.vm.provider "virtualbox" do |vb|
      vb.memory = "2048"
    end
    # Set password for default user 'vagrant'
    db01.vm.provision "shell", inline: <<-SHELL
      echo "vagrant:dbpass123" | chpasswd
    SHELL
  end

  # ----- Memcache VM -----
  config.vm.define "mc01" do |mc01|
    mc01.vm.box = "eurolinux-vagrant/centos-stream-9"
    mc01.vm.box_version = "9.0.43"
    mc01.vm.hostname = "mc01"
    mc01.vm.network "private_network", ip: "192.168.56.91"
    mc01.vm.provider "virtualbox" do |vb|
      vb.memory = "2048"
    end
    mc01.vm.provision "shell", inline: <<-SHELL
      echo "vagrant:mcpass123" | chpasswd
    SHELL
  end

  # ----- RabbitMQ VM -----
  config.vm.define "rmq01" do |rmq01|
    rmq01.vm.box = "eurolinux-vagrant/centos-stream-9"
    rmq01.vm.box_version = "9.0.43"
    rmq01.vm.hostname = "rmq01"
    rmq01.vm.network "private_network", ip: "192.168.56.92"
    rmq01.vm.provider "virtualbox" do |vb|
      vb.memory = "2048"
    end
    rmq01.vm.provision "shell", inline: <<-SHELL
      echo "vagrant:rmqpass123" | chpasswd
    SHELL
  end

  # ----- Tomcat VM -----
  config.vm.define "app01" do |app01|
    app01.vm.box = "eurolinux-vagrant/centos-stream-9"
    app01.vm.box_version = "9.0.43"
    app01.vm.hostname = "app01"
    app01.vm.network "private_network", ip: "192.168.56.93"
    app01.vm.provider "virtualbox" do |vb|
      vb.memory = "4096"
    end
    app01.vm.provision "shell", inline: <<-SHELL
      echo "vagrant:apppass123" | chpasswd
    SHELL
  end

  # ----- Nginx VM -----
  config.vm.define "web01" do |web01|
    web01.vm.box = "ubuntu/jammy64"
    web01.vm.hostname = "web01"
    web01.vm.network "private_network", ip: "192.168.56.94"
    web01.vm.provider "virtualbox" do |vb|
      vb.gui = true
      vb.memory = "4096"
    end
    web01.vm.provision "shell", inline: <<-SHELL
      echo "vagrant:webpass123" | chpasswd
    SHELL
  end
end
```

---


**Part 2: KVM Setup on Linux**

**Step 1: Install KVM and Dependencies**

**Ubuntu/Debian:**

- Install KVM and virtualization packages
```bash
sudo apt install -y qemu-kvm libvirt-daemon-system libvirt-clients \
    bridge-utils virtinst virt-manager
```

- Install build tools for vagrant-libvirt
```bash
sudo apt install -y build-essential libxslt-dev libxml2-dev \
    libvirt-dev zlib1g-dev ruby-dev
```

- Add user to libvirt group
```bash
sudo usermod -a -G libvirt,kvm $(whoami)
newgrp libvirt
```


**Fedora/RHEL/CentOS:**

- Install KVM
```bash
sudo dnf install -y qemu-kvm libvirt virt-install virt-viewer virt-manager
sudo dnf install -y libxslt-devel libxml2-devel libvirt-devel \
    libguestfs-tools-c ruby-devel
```

- Start and enable services
```bash
sudo systemctl start libvirtd
sudo systemctl enable libvirtd
```

- Add user to groups
```bash
sudo usermod -a -G libvirt $(whoami)
```

**Step 2: Install Vagrant Libvirt Plugin**
- Install the plugin
```bash
vagrant plugin install vagrant-libvirt
```

- If you encounter issues, try with dependencies:
```bash
sudo apt install -y pkg-config           # Ubuntu/Debian
```
- OR
```bash
sudo dnf install -y pkgconfig            # Fedora/RHEL
```

- If still having issues, install from a specific branch:
```bash
vagrant plugin install vagrant-libvirt --plugin-version 0.7.0
```

**Step 3: Find KVM Compatible Boxes**
   - Browse available boxes at:
      - https://portal.cloud.hashicorp.com/vagrant/discover
        > At the top of the page, you’ll see a search input. Start by typing keywords like: kvm, libvirt, linux kvm
        > Distribution name + “libvirt” (e.g., ubuntu libvirt)


**Step 4: Create Vagrantfile for KVM**
```bash
mkdir neproject
```
```bash
cd newproject
```
 - Initialize: 
```bash
vagrant init
```
or
```bash
vagrant init generic/ubuntu2204         # Initialize with a libvirt box
```

   - `sudo vim Vagrantfile`

```ruby
Vagrant.configure("2") do |config|
  config.vm.box = "generic/ubuntu2204"

  # KVM/libvirt provider configuration
  config.vm.provider :libvirt do |libvirt|
    # VM Resources
    libvirt.memory = 2048
    libvirt.cpus = 2
    
    # Disk configuration
    libvirt.disk_bus = 'virtio'
    libvirt.storage_pool_name = 'default'
    libvirt.volume_cache = 'none'
    
    # Network configuration
    libvirt.management_network_name = 'vagrant-libvirt'
    libvirt.management_network_address = '192.168.121.0/24'

    # For better performance
    libvirt.nested = true
    libvirt.cpu_mode = 'host-passthrough'
  end
end
```

**Step 5: Start KVM VM**

- Start the VM with the KVM provider
```bash
vagrant up --provider=libvirt
```

- Check status
```bash
vagrant status
```

- SSH into the VM
```bash
vagrant ssh
```

- List libvirt VMs
```bash
sudo virsh list --all
```

---

**KVM Configuration Examples**

**Example 1: Multiple VMs with Private Network**
```ruby
Vagrant.configure("2") do |config|
  config.vm.define "web" do |web|
    web.vm.box = "generic/ubuntu2204"
    web.vm.hostname = "web-server"
    web.vm.provider :libvirt do |libvirt|
      libvirt.memory = 1024
      libvirt.cpus = 1
    end
    web.vm.network "private_network", ip: "192.168.50.10"
  end
  
  config.vm.define "db" do |db|
    db.vm.box = "generic/ubuntu2204"
    db.vm.hostname = "db-server"
    db.vm.provider :libvirt do |libvirt|
      libvirt.memory = 2048
      libvirt.cpus = 2
    end
    db.vm.network "private_network", ip: "192.168.50.11"
  end
end
```

**Example 2: Nested Virtualisation**
```ruby
Vagrant.configure("2") do |config|
  config.vm.box = "generic/ubuntu2204"

  config.vm.provider :libvirt do |libvirt|
    libvirt.memory = 1024
    libvirt.cpus = 1
    libvirt.nested = true
    libvirt.cpu_mode = 'host-passthrough'
    libvirt.cpu_features = [{ name: 'vmx', policy: 'require' }]
  end
end
```

**KVM Specific Commands**

- Manage libvirt networks
```bash
sudo virsh net-list --all
sudo virsh net-edit vagrant-libvirt
```

- Check VM XML configuration
```bash
sudo virsh dumpxml <vm-name>
```

- Take a snapshot
```bash
sudo virsh snapshot-create-as <vm-name> snapshot1
```

- Clone VM
```bash
sudo virt-clone --original <original-vm> --name <new-vm> --auto-clone
```

- Monitor performance
```bash
sudo virt-top
```

- Export VM
```bash
sudo virsh dumpxml <vm-name> > vm-config.xml
```

---

> Note: UTM integration with Vagrant is limited. For production workflows, use VirtualBox for cross platform compatibility, or consider using cloud providers (such as AWS or Azure) with Vagrant for more advanced scenarios.

---
